<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>QextSerialPort: win_qextserialport.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a></div>
<h1>win_qextserialport.cpp</h1><div class="fragment"><pre>00001 
00020 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00021 <span class="preprocessor">#include "win_qextserialport.h"</span>
00022 
<a name="l00047"></a><a class="code" href="classWin__QextSerialPort.html#a0">00047</a> <a class="code" href="classWin__QextSerialPort.html#a0">Win_QextSerialPort::Win_QextSerialPort</a>():<a class="code" href="classQextSerialBase.html">QextSerialBase</a>() {
00048     Win_Handle=INVALID_HANDLE_VALUE;
00049 }
00050 
<a name="l00054"></a><a class="code" href="classWin__QextSerialPort.html#a1">00054</a> <a class="code" href="classWin__QextSerialPort.html#a0">Win_QextSerialPort::Win_QextSerialPort</a>(<span class="keyword">const</span> <a class="code" href="classWin__QextSerialPort.html">Win_QextSerialPort</a>&amp; s):<a class="code" href="classQextSerialBase.html">QextSerialBase</a>(s.portName) {
00055     Win_Handle=INVALID_HANDLE_VALUE;
00056     portOpen=s.<a class="code" href="classQextSerialBase.html#p1">portOpen</a>;
00057     lastErr=s.<a class="code" href="classQextSerialBase.html#p3">lastErr</a>;
00058     memcpy(portName, s.<a class="code" href="classQextSerialBase.html#a5">portName</a>, <span class="keyword">sizeof</span>(portName));
00059     Settings.FlowControl=s.<a class="code" href="classQextSerialBase.html#p2">Settings</a>.FlowControl;
00060     Settings.Parity=s.<a class="code" href="classQextSerialBase.html#p2">Settings</a>.Parity;
00061     Settings.DataBits=s.<a class="code" href="classQextSerialBase.html#p2">Settings</a>.DataBits;
00062     Settings.StopBits=s.<a class="code" href="classQextSerialBase.html#p2">Settings</a>.StopBits;
00063     Settings.BaudRate=s.<a class="code" href="classQextSerialBase.html#p2">Settings</a>.BaudRate;
00064     Win_Handle=s.<a class="code" href="classWin__QextSerialPort.html#p0">Win_Handle</a>;
00065     memcpy(&amp;Win_CommConfig, &amp;s.<a class="code" href="classWin__QextSerialPort.html#p1">Win_CommConfig</a>, <span class="keyword">sizeof</span>(COMMCONFIG));
00066     memcpy(&amp;Win_CommTimeouts, &amp;s.<a class="code" href="classWin__QextSerialPort.html#p2">Win_CommTimeouts</a>, <span class="keyword">sizeof</span>(COMMTIMEOUTS));
00067 }
00068 
<a name="l00075"></a><a class="code" href="classWin__QextSerialPort.html#a2">00075</a> <a class="code" href="classWin__QextSerialPort.html#a0">Win_QextSerialPort::Win_QextSerialPort</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* name):<a class="code" href="classQextSerialBase.html">QextSerialBase</a>(name) {
00076     Win_Handle=INVALID_HANDLE_VALUE;
00077 }
00078 
<a name="l00083"></a><a class="code" href="classWin__QextSerialPort.html#a3">00083</a> <a class="code" href="classWin__QextSerialPort.html#a0">Win_QextSerialPort::Win_QextSerialPort</a>(<span class="keyword">const</span> PortSettings&amp; settings) {
00084     Win_Handle=INVALID_HANDLE_VALUE;
00085     <a class="code" href="classWin__QextSerialPort.html#a18">setBaudRate</a>(settings.BaudRate);
00086     <a class="code" href="classWin__QextSerialPort.html#a16">setDataBits</a>(settings.DataBits);
00087     <a class="code" href="classWin__QextSerialPort.html#a17">setStopBits</a>(settings.StopBits);
00088     <a class="code" href="classWin__QextSerialPort.html#a15">setParity</a>(settings.Parity);
00089     <a class="code" href="classWin__QextSerialPort.html#a14">setFlowControl</a>(settings.FlowControl);
00090     <a class="code" href="classWin__QextSerialPort.html#a24">setTimeout</a>(settings.Timeout_Sec, settings.Timeout_Millisec);
00091 }
00092 
<a name="l00097"></a><a class="code" href="classWin__QextSerialPort.html#a4">00097</a> <a class="code" href="classWin__QextSerialPort.html#a0">Win_QextSerialPort::Win_QextSerialPort</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* name, <span class="keyword">const</span> PortSettings&amp; settings) {
00098     Win_Handle=INVALID_HANDLE_VALUE;
00099     setName(name);
00100     <a class="code" href="classWin__QextSerialPort.html#a18">setBaudRate</a>(settings.BaudRate);
00101     <a class="code" href="classWin__QextSerialPort.html#a16">setDataBits</a>(settings.DataBits);
00102     <a class="code" href="classWin__QextSerialPort.html#a17">setStopBits</a>(settings.StopBits);
00103     <a class="code" href="classWin__QextSerialPort.html#a15">setParity</a>(settings.Parity);
00104     <a class="code" href="classWin__QextSerialPort.html#a14">setFlowControl</a>(settings.FlowControl);
00105     <a class="code" href="classWin__QextSerialPort.html#a24">setTimeout</a>(settings.Timeout_Sec, settings.Timeout_Millisec);
00106 }
00107 
<a name="l00112"></a><a class="code" href="classWin__QextSerialPort.html#a6">00112</a> <a class="code" href="classWin__QextSerialPort.html#a6">Win_QextSerialPort::~Win_QextSerialPort</a>() {
00113     <span class="keywordflow">if</span> (portOpen) {
00114         <a class="code" href="classWin__QextSerialPort.html#a8">close</a>();
00115     }
00116 }
00117 
00122 <a class="code" href="classWin__QextSerialPort.html">Win_QextSerialPort</a>&amp; Win_QextSerialPort::operator=(<span class="keyword">const</span> <a class="code" href="classWin__QextSerialPort.html">Win_QextSerialPort</a>&amp; s) {
00123     portOpen=s.<a class="code" href="classQextSerialBase.html#a18">isOpen</a>();
00124     lastErr=s.<a class="code" href="classQextSerialBase.html#p3">lastErr</a>;
00125     memcpy(portName, s.<a class="code" href="classQextSerialBase.html#a5">portName</a>, <span class="keyword">sizeof</span>(portName));
00126     Settings.FlowControl=s.<a class="code" href="classQextSerialBase.html#p2">Settings</a>.FlowControl;
00127     Settings.Parity=s.<a class="code" href="classQextSerialBase.html#p2">Settings</a>.Parity;
00128     Settings.DataBits=s.<a class="code" href="classQextSerialBase.html#p2">Settings</a>.DataBits;
00129     Settings.StopBits=s.<a class="code" href="classQextSerialBase.html#p2">Settings</a>.StopBits;
00130     Settings.BaudRate=s.<a class="code" href="classQextSerialBase.html#p2">Settings</a>.BaudRate;
00131     Win_Handle=s.<a class="code" href="classWin__QextSerialPort.html#p0">Win_Handle</a>;
00132     memcpy(&amp;Win_CommConfig, &amp;s.<a class="code" href="classWin__QextSerialPort.html#p1">Win_CommConfig</a>, <span class="keyword">sizeof</span>(COMMCONFIG));
00133     memcpy(&amp;Win_CommTimeouts, &amp;s.<a class="code" href="classWin__QextSerialPort.html#p2">Win_CommTimeouts</a>, <span class="keyword">sizeof</span>(COMMTIMEOUTS));
00134     <span class="keywordflow">return</span> *<span class="keyword">this</span>;
00135 }
00136 
<a name="l00144"></a><a class="code" href="classWin__QextSerialPort.html#a7">00144</a> <span class="keywordtype">bool</span> <a class="code" href="classWin__QextSerialPort.html#a7">Win_QextSerialPort::open</a>(<span class="keywordtype">int</span>) {
00145     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> confSize;
00146     LOCK_MUTEX();
00147     <span class="keywordflow">if</span> (!portOpen) {
00148 
00149         <span class="comment">/*open the port*/</span>
00150         Win_Handle=CreateFileA(portName, GENERIC_READ|GENERIC_WRITE,
00151                               FILE_SHARE_READ|FILE_SHARE_WRITE, NULL, OPEN_EXISTING, 0, NULL);
00152         <span class="keywordflow">if</span> (Win_Handle!=INVALID_HANDLE_VALUE) {
00153             portOpen=<span class="keyword">true</span>;
00154 
00155             <span class="comment">/*configure port settings*/</span>
00156             GetCommConfig(Win_Handle, &amp;Win_CommConfig, &amp;confSize);
00157             GetCommState(Win_Handle, &amp;(Win_CommConfig.dcb));
00158 
00159             <span class="comment">/*set up parameters*/</span>
00160             Win_CommConfig.dcb.fBinary=TRUE;
00161             Win_CommConfig.dcb.fInX=FALSE;
00162             Win_CommConfig.dcb.fOutX=FALSE;
00163             Win_CommConfig.dcb.fAbortOnError=FALSE;
00164             Win_CommConfig.dcb.fNull=FALSE;
00165             <a class="code" href="classWin__QextSerialPort.html#a18">setBaudRate</a>(Settings.BaudRate);
00166             <a class="code" href="classWin__QextSerialPort.html#a16">setDataBits</a>(Settings.DataBits);
00167             <a class="code" href="classWin__QextSerialPort.html#a17">setStopBits</a>(Settings.StopBits);
00168             <a class="code" href="classWin__QextSerialPort.html#a15">setParity</a>(Settings.Parity);
00169             <a class="code" href="classWin__QextSerialPort.html#a14">setFlowControl</a>(Settings.FlowControl);
00170             <a class="code" href="classWin__QextSerialPort.html#a24">setTimeout</a>(Settings.Timeout_Sec, Settings.Timeout_Millisec);
00171             SetCommConfig(Win_Handle, &amp;Win_CommConfig, <span class="keyword">sizeof</span>(COMMCONFIG));
00172         }
00173     }
00174     UNLOCK_MUTEX();
00175     <span class="keywordflow">return</span> portOpen;
00176 }
00177 
<a name="l00183"></a><a class="code" href="classWin__QextSerialPort.html#a8">00183</a> <span class="keywordtype">void</span> <a class="code" href="classWin__QextSerialPort.html#a8">Win_QextSerialPort::close</a>() {
00184     LOCK_MUTEX();
00185     CloseHandle(Win_Handle);
00186     portOpen=<span class="keyword">false</span>;
00187     UNLOCK_MUTEX();
00188 }
00189 
<a name="l00195"></a><a class="code" href="classWin__QextSerialPort.html#a9">00195</a> <span class="keywordtype">void</span> <a class="code" href="classWin__QextSerialPort.html#a9">Win_QextSerialPort::flush</a>() {
00196     LOCK_MUTEX();
00197     <span class="keywordflow">if</span> (portOpen) {
00198         FlushFileBuffers(Win_Handle);
00199     }
00200     UNLOCK_MUTEX();
00201 }
00202 
<a name="l00210"></a><a class="code" href="classWin__QextSerialPort.html#a10">00210</a> Offset <a class="code" href="classWin__QextSerialPort.html#a10">Win_QextSerialPort::size</a>()<span class="keyword"> const </span>{
00211     <span class="keywordtype">int</span> availBytes;
00212     COMSTAT Win_ComStat;
00213     DWORD Win_ErrorMask=0;
00214     ClearCommError(Win_Handle, &amp;Win_ErrorMask, &amp;Win_ComStat);
00215     availBytes = Win_ComStat.cbInQue;
00216     <span class="keywordflow">return</span> (Offset)availBytes;
00217 }
00218 
<a name="l00225"></a><a class="code" href="classWin__QextSerialPort.html#a22">00225</a> <span class="keywordtype">int</span> <a class="code" href="classWin__QextSerialPort.html#a22">Win_QextSerialPort::bytesWaiting</a>() {
00226     LOCK_MUTEX();
00227     <span class="keywordflow">if</span> (portOpen) {
00228         DWORD Errors;
00229         COMSTAT Status;
00230         <span class="keywordtype">bool</span> success=ClearCommError(Win_Handle, &amp;Errors, &amp;Status);
00231         <a class="code" href="classWin__QextSerialPort.html#a23">translateError</a>(Errors);
00232         <span class="keywordflow">if</span> (success) {
00233             lastErr=E_NO_ERROR;
00234             UNLOCK_MUTEX();
00235             <span class="keywordflow">return</span> Status.cbInQue;
00236         }
00237         UNLOCK_MUTEX();
00238         <span class="keywordflow">return</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)-1;
00239     }
00240     UNLOCK_MUTEX();
00241     <span class="keywordflow">return</span> 0;
00242 }
00243 
<a name="l00248"></a><a class="code" href="classWin__QextSerialPort.html#a23">00248</a> <span class="keywordtype">void</span> <a class="code" href="classWin__QextSerialPort.html#a23">Win_QextSerialPort::translateError</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> error) {
00249     <span class="keywordflow">if</span> (error&amp;CE_BREAK) {
00250         lastErr=E_BREAK_CONDITION;
00251     }
00252     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (error&amp;CE_FRAME) {
00253         lastErr=E_FRAMING_ERROR;
00254     }
00255     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (error&amp;CE_IOE) {
00256         lastErr=E_IO_ERROR;
00257     }
00258     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (error&amp;CE_MODE) {
00259         lastErr=E_INVALID_FD;
00260     }
00261     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (error&amp;CE_OVERRUN) {
00262         lastErr=E_BUFFER_OVERRUN;
00263     }
00264     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (error&amp;CE_RXPARITY) {
00265         lastErr=E_RECEIVE_PARITY_ERROR;
00266     }
00267     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (error&amp;CE_RXOVER) {
00268         lastErr=E_RECEIVE_OVERFLOW;
00269     }
00270     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (error&amp;CE_TXFULL) {
00271         lastErr=E_TRANSMIT_OVERFLOW;
00272     }
00273 }
00274 
00282 Q_LONG Win_QextSerialPort::readBlock(<span class="keywordtype">char</span> *data,
00283 #ifdef QTVER_PRE_30
00284                                      uint maxlen)
00285 #<span class="keywordflow">else</span>
00286                                      <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> maxlen)
00287 <span class="preprocessor">#endif</span>
00288 <span class="preprocessor"></span>{
00289     LOCK_MUTEX();
00290     <span class="keywordtype">int</span> retVal=0;
00291     <span class="keywordflow">if</span> (portOpen) {
00292         COMSTAT Win_ComStat;
00293         DWORD Win_BytesRead=0;
00294         DWORD Win_ErrorMask=0;
00295         ClearCommError(Win_Handle, &amp;Win_ErrorMask, &amp;Win_ComStat);
00296         <span class="keywordflow">if</span> (Win_ComStat.cbInQue &amp;&amp;
00297             (!ReadFile(Win_Handle, (<span class="keywordtype">void</span>*)data, (DWORD)maxlen, &amp;Win_BytesRead, NULL)
00298             || Win_BytesRead==0)) {
00299             lastErr=E_READ_FAILED;
00300             retVal=-1;
00301         }
00302         <span class="keywordflow">else</span> {
00303             retVal=((<span class="keywordtype">int</span>)Win_BytesRead);
00304         }
00305     }
00306     UNLOCK_MUTEX();
00307     <span class="keywordflow">return</span> retVal;
00308 }
00309 
00317 Q_LONG Win_QextSerialPort::writeBlock(<span class="keyword">const</span> <span class="keywordtype">char</span> *data,
00318 #ifdef QTVER_PRE_30
00319                                       uint len)
00320 #<span class="keywordflow">else</span>
00321                                       <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> len)
00322 <span class="preprocessor">#endif</span>
00323 <span class="preprocessor"></span>{
00324     LOCK_MUTEX();
00325     <span class="keywordtype">int</span> retVal=0;
00326     <span class="keywordflow">if</span> (portOpen) {
00327         DWORD Win_BytesWritten;
00328         <span class="keywordflow">if</span> (!WriteFile(Win_Handle, (<span class="keywordtype">void</span>*)data, (DWORD)len, &amp;Win_BytesWritten, NULL)) {
00329             lastErr=E_WRITE_FAILED;
00330             retVal=-1;
00331         }
00332         <span class="keywordflow">else</span> {
00333             retVal=((<span class="keywordtype">int</span>)Win_BytesWritten);
00334         }
00335     }
00336     UNLOCK_MUTEX();
00337     flush();
00338     <span class="keywordflow">return</span> retVal;
00339 }
00340 
<a name="l00346"></a><a class="code" href="classWin__QextSerialPort.html#a11">00346</a> <span class="keywordtype">int</span> <a class="code" href="classWin__QextSerialPort.html#a11">Win_QextSerialPort::getch</a>() {
00347     LOCK_MUTEX();
00348     <span class="keywordtype">int</span> retVal=-1;
00349     <span class="keywordflow">if</span> (portOpen) {
00350         <span class="keywordtype">int</span> readChar=0;
00351         COMSTAT Win_ComStat;
00352         DWORD Win_BytesRead=0;
00353         DWORD Win_ErrorMask=0;
00354         ClearCommError(Win_Handle, &amp;Win_ErrorMask, &amp;Win_ComStat);
00355         <span class="keywordflow">if</span> (Win_ComStat.cbInQue) {
00356             <span class="keywordflow">if</span> (!ReadFile(Win_Handle, (<span class="keywordtype">void</span>*)&amp;readChar, 1, &amp;Win_BytesRead, NULL)
00357                 || Win_BytesRead==0) {
00358                 retVal=-1;
00359                 lastErr=E_READ_FAILED;
00360             }
00361             <span class="keywordflow">else</span> {
00362                 retVal=readChar;
00363             }
00364         }
00365     }
00366     UNLOCK_MUTEX();
00367     <span class="keywordflow">return</span> retVal;
00368 }
00369 
<a name="l00376"></a><a class="code" href="classWin__QextSerialPort.html#a12">00376</a> <span class="keywordtype">int</span> <a class="code" href="classWin__QextSerialPort.html#a12">Win_QextSerialPort::putch</a>(<span class="keywordtype">int</span> ch) {
00377     LOCK_MUTEX();
00378     <span class="keywordtype">int</span> retVal=0;
00379     <span class="keywordflow">if</span> (portOpen) {
00380         DWORD Win_BytesWritten;
00381         <span class="keywordflow">if</span> (!WriteFile(Win_Handle, (<span class="keywordtype">void</span>*)&amp;ch, 1, &amp;Win_BytesWritten, NULL)) {
00382             retVal=-1;
00383             lastErr=E_WRITE_FAILED;
00384         }
00385         <span class="keywordflow">else</span> {
00386             retVal=ch;
00387         }
00388     }
00389     UNLOCK_MUTEX();
00390     <a class="code" href="classWin__QextSerialPort.html#a9">flush</a>();
00391     <span class="keywordflow">return</span> retVal;
00392 }
00393 
<a name="l00400"></a><a class="code" href="classWin__QextSerialPort.html#a13">00400</a> <span class="keywordtype">int</span> <a class="code" href="classWin__QextSerialPort.html#a13">Win_QextSerialPort::ungetch</a>(<span class="keywordtype">int</span>) {
00401 
00402     <span class="comment">/*meaningless on unbuffered sequential device - return error and print a warning*/</span>
00403     TTY_WARNING(<span class="stringliteral">"Win_QextSerialPort: ungetch() called on an unbuffered sequential device - operation is meaningless"</span>);
00404     <span class="keywordflow">return</span> -1;
00405 }
00406 
<a name="l00416"></a><a class="code" href="classWin__QextSerialPort.html#a14">00416</a> <span class="keywordtype">void</span> <a class="code" href="classWin__QextSerialPort.html#a14">Win_QextSerialPort::setFlowControl</a>(FlowType flow) {
00417     LOCK_MUTEX();
00418     <span class="keywordflow">if</span> (Settings.FlowControl!=flow) {
00419         Settings.FlowControl=flow;
00420     }
00421     <span class="keywordflow">if</span> (portOpen) {
00422         <span class="keywordflow">switch</span>(flow) {
00423 
00424             <span class="comment">/*no flow control*/</span>
00425             <span class="keywordflow">case</span> FLOW_OFF:
00426                 Win_CommConfig.dcb.fOutxCtsFlow=FALSE;
00427                 Win_CommConfig.dcb.fRtsControl=RTS_CONTROL_DISABLE;
00428                 Win_CommConfig.dcb.fInX=FALSE;
00429                 Win_CommConfig.dcb.fOutX=FALSE;
00430                 SetCommConfig(Win_Handle, &amp;Win_CommConfig, <span class="keyword">sizeof</span>(COMMCONFIG));
00431                 <span class="keywordflow">break</span>;
00432 
00433             <span class="comment">/*software (XON/XOFF) flow control*/</span>
00434             <span class="keywordflow">case</span> FLOW_XONXOFF:
00435                 Win_CommConfig.dcb.fOutxCtsFlow=FALSE;
00436                 Win_CommConfig.dcb.fRtsControl=RTS_CONTROL_DISABLE;
00437                 Win_CommConfig.dcb.fInX=TRUE;
00438                 Win_CommConfig.dcb.fOutX=TRUE;
00439                 SetCommConfig(Win_Handle, &amp;Win_CommConfig, <span class="keyword">sizeof</span>(COMMCONFIG));
00440                 <span class="keywordflow">break</span>;
00441 
00442             <span class="keywordflow">case</span> FLOW_HARDWARE:
00443                 Win_CommConfig.dcb.fOutxCtsFlow=TRUE;
00444                 Win_CommConfig.dcb.fRtsControl=RTS_CONTROL_HANDSHAKE;
00445                 Win_CommConfig.dcb.fInX=FALSE;
00446                 Win_CommConfig.dcb.fOutX=FALSE;
00447                 SetCommConfig(Win_Handle, &amp;Win_CommConfig, <span class="keyword">sizeof</span>(COMMCONFIG));
00448                 <span class="keywordflow">break</span>;
00449         }
00450     }
00451     UNLOCK_MUTEX();
00452 }
00453 
<a name="l00465"></a><a class="code" href="classWin__QextSerialPort.html#a15">00465</a> <span class="keywordtype">void</span> <a class="code" href="classWin__QextSerialPort.html#a15">Win_QextSerialPort::setParity</a>(ParityType parity) {
00466     LOCK_MUTEX();
00467     <span class="keywordflow">if</span> (Settings.Parity!=parity) {
00468         Settings.Parity=parity;
00469     }
00470     <span class="keywordflow">if</span> (portOpen) {
00471         Win_CommConfig.dcb.Parity=(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)parity;
00472         <span class="keywordflow">switch</span> (parity) {
00473 
00474             <span class="comment">/*space parity*/</span>
00475             <span class="keywordflow">case</span> PAR_SPACE:
00476                 <span class="keywordflow">if</span> (Settings.DataBits==DATA_8) {
00477                     TTY_PORTABILITY_WARNING(<span class="stringliteral">"Win_QextSerialPort Portability Warning: Space parity with 8 data bits is not supported by POSIX systems."</span>);
00478                 }
00479                 Win_CommConfig.dcb.fParity=TRUE;
00480                 <span class="keywordflow">break</span>;
00481 
00482             <span class="comment">/*mark parity - WINDOWS ONLY*/</span>
00483             <span class="keywordflow">case</span> PAR_MARK:
00484                 TTY_PORTABILITY_WARNING(<span class="stringliteral">"Win_QextSerialPort Portability Warning:  Mark parity is not supported by POSIX systems"</span>);
00485                 Win_CommConfig.dcb.fParity=TRUE;
00486                 <span class="keywordflow">break</span>;
00487 
00488             <span class="comment">/*no parity*/</span>
00489             <span class="keywordflow">case</span> PAR_NONE:
00490                 Win_CommConfig.dcb.fParity=FALSE;
00491                 <span class="keywordflow">break</span>;
00492 
00493             <span class="comment">/*even parity*/</span>
00494             <span class="keywordflow">case</span> PAR_EVEN:
00495                 Win_CommConfig.dcb.fParity=TRUE;
00496                 <span class="keywordflow">break</span>;
00497 
00498             <span class="comment">/*odd parity*/</span>
00499             <span class="keywordflow">case</span> PAR_ODD:
00500                 Win_CommConfig.dcb.fParity=TRUE;
00501                 <span class="keywordflow">break</span>;
00502         }
00503         SetCommConfig(Win_Handle, &amp;Win_CommConfig, <span class="keyword">sizeof</span>(COMMCONFIG));
00504     }
00505     UNLOCK_MUTEX();
00506 }
00507 
<a name="l00528"></a><a class="code" href="classWin__QextSerialPort.html#a16">00528</a> <span class="keywordtype">void</span> <a class="code" href="classWin__QextSerialPort.html#a16">Win_QextSerialPort::setDataBits</a>(DataBitsType dataBits) {
00529     LOCK_MUTEX();
00530     <span class="keywordflow">if</span> (Settings.DataBits!=dataBits) {
00531         <span class="keywordflow">if</span> ((Settings.StopBits==STOP_2 &amp;&amp; dataBits==DATA_5) ||
00532             (Settings.StopBits==STOP_1_5 &amp;&amp; dataBits!=DATA_5)) {
00533         }
00534         <span class="keywordflow">else</span> {
00535             Settings.DataBits=dataBits;
00536         }
00537     }
00538     <span class="keywordflow">if</span> (portOpen) {
00539         <span class="keywordflow">switch</span>(dataBits) {
00540 
00541             <span class="comment">/*5 data bits*/</span>
00542             <span class="keywordflow">case</span> DATA_5:
00543                 <span class="keywordflow">if</span> (Settings.StopBits==STOP_2) {
00544                     TTY_WARNING(<span class="stringliteral">"Win_QextSerialPort: 5 Data bits cannot be used with 2 stop bits."</span>);
00545                 }
00546                 <span class="keywordflow">else</span> {
00547                     Win_CommConfig.dcb.ByteSize=5;
00548                     SetCommConfig(Win_Handle, &amp;Win_CommConfig, <span class="keyword">sizeof</span>(COMMCONFIG));
00549                 }
00550                 <span class="keywordflow">break</span>;
00551 
00552             <span class="comment">/*6 data bits*/</span>
00553             <span class="keywordflow">case</span> DATA_6:
00554                 <span class="keywordflow">if</span> (Settings.StopBits==STOP_1_5) {
00555                     TTY_WARNING(<span class="stringliteral">"Win_QextSerialPort: 6 Data bits cannot be used with 1.5 stop bits."</span>);
00556                 }
00557                 <span class="keywordflow">else</span> {
00558                     Win_CommConfig.dcb.ByteSize=6;
00559                     SetCommConfig(Win_Handle, &amp;Win_CommConfig, <span class="keyword">sizeof</span>(COMMCONFIG));
00560                 }
00561                 <span class="keywordflow">break</span>;
00562 
00563             <span class="comment">/*7 data bits*/</span>
00564             <span class="keywordflow">case</span> DATA_7:
00565                 <span class="keywordflow">if</span> (Settings.StopBits==STOP_1_5) {
00566                     TTY_WARNING(<span class="stringliteral">"Win_QextSerialPort: 7 Data bits cannot be used with 1.5 stop bits."</span>);
00567                 }
00568                 <span class="keywordflow">else</span> {
00569                     Win_CommConfig.dcb.ByteSize=7;
00570                     SetCommConfig(Win_Handle, &amp;Win_CommConfig, <span class="keyword">sizeof</span>(COMMCONFIG));
00571                 }
00572                 <span class="keywordflow">break</span>;
00573 
00574             <span class="comment">/*8 data bits*/</span>
00575             <span class="keywordflow">case</span> DATA_8:
00576                 <span class="keywordflow">if</span> (Settings.StopBits==STOP_1_5) {
00577                     TTY_WARNING(<span class="stringliteral">"Win_QextSerialPort: 8 Data bits cannot be used with 1.5 stop bits."</span>);
00578                 }
00579                 <span class="keywordflow">else</span> {
00580                     Win_CommConfig.dcb.ByteSize=8;
00581                     SetCommConfig(Win_Handle, &amp;Win_CommConfig, <span class="keyword">sizeof</span>(COMMCONFIG));
00582                 }
00583                 <span class="keywordflow">break</span>;
00584         }
00585     }
00586     UNLOCK_MUTEX();
00587 }
00588 
<a name="l00607"></a><a class="code" href="classWin__QextSerialPort.html#a17">00607</a> <span class="keywordtype">void</span> <a class="code" href="classWin__QextSerialPort.html#a17">Win_QextSerialPort::setStopBits</a>(StopBitsType stopBits) {
00608     LOCK_MUTEX();
00609     <span class="keywordflow">if</span> (Settings.StopBits!=stopBits) {
00610         <span class="keywordflow">if</span> ((Settings.DataBits==DATA_5 &amp;&amp; stopBits==STOP_2) ||
00611             (stopBits==STOP_1_5 &amp;&amp; Settings.DataBits!=DATA_5)) {
00612         }
00613         <span class="keywordflow">else</span> {
00614             Settings.StopBits=stopBits;
00615         }
00616     }
00617     <span class="keywordflow">if</span> (portOpen) {
00618         <span class="keywordflow">switch</span> (stopBits) {
00619 
00620             <span class="comment">/*one stop bit*/</span>
00621             <span class="keywordflow">case</span> STOP_1:
00622                 Win_CommConfig.dcb.StopBits=ONESTOPBIT;
00623                 SetCommConfig(Win_Handle, &amp;Win_CommConfig, <span class="keyword">sizeof</span>(COMMCONFIG));
00624                 <span class="keywordflow">break</span>;
00625 
00626             <span class="comment">/*1.5 stop bits*/</span>
00627             <span class="keywordflow">case</span> STOP_1_5:
00628                 TTY_PORTABILITY_WARNING(<span class="stringliteral">"Win_QextSerialPort Portability Warning: 1.5 stop bit operation is not supported by POSIX."</span>);
00629                 <span class="keywordflow">if</span> (Settings.DataBits!=DATA_5) {
00630                     TTY_WARNING(<span class="stringliteral">"Win_QextSerialPort: 1.5 stop bits can only be used with 5 data bits"</span>);
00631                 }
00632                 <span class="keywordflow">else</span> {
00633                     Win_CommConfig.dcb.StopBits=ONE5STOPBITS;
00634                     SetCommConfig(Win_Handle, &amp;Win_CommConfig, <span class="keyword">sizeof</span>(COMMCONFIG));
00635                 }
00636                 <span class="keywordflow">break</span>;
00637 
00638             <span class="comment">/*two stop bits*/</span>
00639             <span class="keywordflow">case</span> STOP_2:
00640                 <span class="keywordflow">if</span> (Settings.DataBits==DATA_5) {
00641                     TTY_WARNING(<span class="stringliteral">"Win_QextSerialPort: 2 stop bits cannot be used with 5 data bits"</span>);
00642                 }
00643                 <span class="keywordflow">else</span> {
00644                     Win_CommConfig.dcb.StopBits=TWOSTOPBITS;
00645                     SetCommConfig(Win_Handle, &amp;Win_CommConfig, <span class="keyword">sizeof</span>(COMMCONFIG));
00646                 }
00647                 <span class="keywordflow">break</span>;
00648         }
00649     }
00650     UNLOCK_MUTEX();
00651 }
00652 
<a name="l00687"></a><a class="code" href="classWin__QextSerialPort.html#a18">00687</a> <span class="keywordtype">void</span> <a class="code" href="classWin__QextSerialPort.html#a18">Win_QextSerialPort::setBaudRate</a>(BaudRateType baudRate) {
00688     LOCK_MUTEX();
00689     <span class="keywordflow">if</span> (Settings.BaudRate!=baudRate) {
00690         <span class="keywordflow">switch</span> (baudRate) {
00691             <span class="keywordflow">case</span> BAUD50:
00692             <span class="keywordflow">case</span> BAUD75:
00693             <span class="keywordflow">case</span> BAUD134:
00694             <span class="keywordflow">case</span> BAUD150:
00695             <span class="keywordflow">case</span> BAUD200:
00696                 Settings.BaudRate=BAUD110;
00697                 <span class="keywordflow">break</span>;
00698 
00699             <span class="keywordflow">case</span> BAUD1800:
00700                 Settings.BaudRate=BAUD1200;
00701                 <span class="keywordflow">break</span>;
00702 
00703             <span class="keywordflow">case</span> BAUD76800:
00704                 Settings.BaudRate=BAUD57600;
00705                 <span class="keywordflow">break</span>;
00706 
00707             <span class="keywordflow">default</span>:
00708                 Settings.BaudRate=baudRate;
00709                 <span class="keywordflow">break</span>;
00710         }
00711     }
00712     <span class="keywordflow">if</span> (portOpen) {
00713         <span class="keywordflow">switch</span> (baudRate) {
00714 
00715             <span class="comment">/*50 baud*/</span>
00716             <span class="keywordflow">case</span> BAUD50:
00717                 TTY_WARNING(<span class="stringliteral">"Win_QextSerialPort: Windows does not support 50 baud operation.  Switching to 110 baud."</span>);
00718                 Win_CommConfig.dcb.BaudRate=CBR_110;
00719                 <span class="keywordflow">break</span>;
00720 
00721             <span class="comment">/*75 baud*/</span>
00722             <span class="keywordflow">case</span> BAUD75:
00723                 TTY_WARNING(<span class="stringliteral">"Win_QextSerialPort: Windows does not support 75 baud operation.  Switching to 110 baud."</span>);
00724                 Win_CommConfig.dcb.BaudRate=CBR_110;
00725                 <span class="keywordflow">break</span>;
00726 
00727             <span class="comment">/*110 baud*/</span>
00728             <span class="keywordflow">case</span> BAUD110:
00729                 Win_CommConfig.dcb.BaudRate=CBR_110;
00730                 <span class="keywordflow">break</span>;
00731 
00732             <span class="comment">/*134.5 baud*/</span>
00733             <span class="keywordflow">case</span> BAUD134:
00734                 TTY_WARNING(<span class="stringliteral">"Win_QextSerialPort: Windows does not support 134.5 baud operation.  Switching to 110 baud."</span>);
00735                 Win_CommConfig.dcb.BaudRate=CBR_110;
00736                 <span class="keywordflow">break</span>;
00737 
00738             <span class="comment">/*150 baud*/</span>
00739             <span class="keywordflow">case</span> BAUD150:
00740                 TTY_WARNING(<span class="stringliteral">"Win_QextSerialPort: Windows does not support 150 baud operation.  Switching to 110 baud."</span>);
00741                 Win_CommConfig.dcb.BaudRate=CBR_110;
00742                 <span class="keywordflow">break</span>;
00743 
00744             <span class="comment">/*200 baud*/</span>
00745             <span class="keywordflow">case</span> BAUD200:
00746                 TTY_WARNING(<span class="stringliteral">"Win_QextSerialPort: Windows does not support 200 baud operation.  Switching to 110 baud."</span>);
00747                 Win_CommConfig.dcb.BaudRate=CBR_110;
00748                 <span class="keywordflow">break</span>;
00749 
00750             <span class="comment">/*300 baud*/</span>
00751             <span class="keywordflow">case</span> BAUD300:
00752                 Win_CommConfig.dcb.BaudRate=CBR_300;
00753                 <span class="keywordflow">break</span>;
00754 
00755             <span class="comment">/*600 baud*/</span>
00756             <span class="keywordflow">case</span> BAUD600:
00757                 Win_CommConfig.dcb.BaudRate=CBR_600;
00758                 <span class="keywordflow">break</span>;
00759 
00760             <span class="comment">/*1200 baud*/</span>
00761             <span class="keywordflow">case</span> BAUD1200:
00762                 Win_CommConfig.dcb.BaudRate=CBR_1200;
00763                 <span class="keywordflow">break</span>;
00764 
00765             <span class="comment">/*1800 baud*/</span>
00766             <span class="keywordflow">case</span> BAUD1800:
00767                 TTY_WARNING(<span class="stringliteral">"Win_QextSerialPort: Windows does not support 1800 baud operation.  Switching to 1200 baud."</span>);
00768                 Win_CommConfig.dcb.BaudRate=CBR_1200;
00769                 <span class="keywordflow">break</span>;
00770 
00771             <span class="comment">/*2400 baud*/</span>
00772             <span class="keywordflow">case</span> BAUD2400:
00773                 Win_CommConfig.dcb.BaudRate=CBR_2400;
00774                 <span class="keywordflow">break</span>;
00775 
00776             <span class="comment">/*4800 baud*/</span>
00777             <span class="keywordflow">case</span> BAUD4800:
00778                 Win_CommConfig.dcb.BaudRate=CBR_4800;
00779                 <span class="keywordflow">break</span>;
00780 
00781             <span class="comment">/*9600 baud*/</span>
00782             <span class="keywordflow">case</span> BAUD9600:
00783                 Win_CommConfig.dcb.BaudRate=CBR_9600;
00784                 <span class="keywordflow">break</span>;
00785 
00786             <span class="comment">/*14400 baud*/</span>
00787             <span class="keywordflow">case</span> BAUD14400:
00788                 TTY_PORTABILITY_WARNING(<span class="stringliteral">"Win_QextSerialPort Portability Warning: POSIX does not support 14400 baud operation."</span>);
00789                 Win_CommConfig.dcb.BaudRate=CBR_14400;
00790                 <span class="keywordflow">break</span>;
00791 
00792             <span class="comment">/*19200 baud*/</span>
00793             <span class="keywordflow">case</span> BAUD19200:
00794                 Win_CommConfig.dcb.BaudRate=CBR_19200;
00795                 <span class="keywordflow">break</span>;
00796 
00797             <span class="comment">/*38400 baud*/</span>
00798             <span class="keywordflow">case</span> BAUD38400:
00799                 Win_CommConfig.dcb.BaudRate=CBR_38400;
00800                 <span class="keywordflow">break</span>;
00801 
00802             <span class="comment">/*56000 baud*/</span>
00803             <span class="keywordflow">case</span> BAUD56000:
00804                 TTY_PORTABILITY_WARNING(<span class="stringliteral">"Win_QextSerialPort Portability Warning: POSIX does not support 56000 baud operation."</span>);
00805                 Win_CommConfig.dcb.BaudRate=CBR_56000;
00806                 <span class="keywordflow">break</span>;
00807 
00808             <span class="comment">/*57600 baud*/</span>
00809             <span class="keywordflow">case</span> BAUD57600:
00810                 Win_CommConfig.dcb.BaudRate=CBR_57600;
00811                 <span class="keywordflow">break</span>;
00812 
00813             <span class="comment">/*76800 baud*/</span>
00814             <span class="keywordflow">case</span> BAUD76800:
00815                 TTY_WARNING(<span class="stringliteral">"Win_QextSerialPort: Windows does not support 76800 baud operation.  Switching to 57600 baud."</span>);
00816                 Win_CommConfig.dcb.BaudRate=CBR_57600;
00817                 <span class="keywordflow">break</span>;
00818 
00819             <span class="comment">/*115200 baud*/</span>
00820             <span class="keywordflow">case</span> BAUD115200:
00821                 Win_CommConfig.dcb.BaudRate=CBR_115200;
00822                 <span class="keywordflow">break</span>;
00823 
00824             <span class="comment">/*128000 baud*/</span>
00825             <span class="keywordflow">case</span> BAUD128000:
00826                 TTY_PORTABILITY_WARNING(<span class="stringliteral">"Win_QextSerialPort Portability Warning: POSIX does not support 128000 baud operation."</span>);
00827                 Win_CommConfig.dcb.BaudRate=CBR_128000;
00828                 <span class="keywordflow">break</span>;
00829 
00830             <span class="comment">/*256000 baud*/</span>
00831             <span class="keywordflow">case</span> BAUD256000:
00832                 TTY_PORTABILITY_WARNING(<span class="stringliteral">"Win_QextSerialPort Portability Warning: POSIX does not support 256000 baud operation."</span>);
00833                 Win_CommConfig.dcb.BaudRate=CBR_256000;
00834                 <span class="keywordflow">break</span>;
00835         }
00836         SetCommConfig(Win_Handle, &amp;Win_CommConfig, <span class="keyword">sizeof</span>(COMMCONFIG));
00837     }
00838     UNLOCK_MUTEX();
00839 }
00840 
<a name="l00846"></a><a class="code" href="classWin__QextSerialPort.html#a19">00846</a> <span class="keywordtype">void</span> <a class="code" href="classWin__QextSerialPort.html#a19">Win_QextSerialPort::setDtr</a>(<span class="keywordtype">bool</span> set) {
00847     LOCK_MUTEX();
00848     <span class="keywordflow">if</span> (portOpen) {
00849         <span class="keywordflow">if</span> (set) {
00850             EscapeCommFunction(Win_Handle, SETDTR);
00851         }
00852         <span class="keywordflow">else</span> {
00853             EscapeCommFunction(Win_Handle, CLRDTR);
00854         }
00855     }
00856     UNLOCK_MUTEX();
00857 }
00858 
<a name="l00864"></a><a class="code" href="classWin__QextSerialPort.html#a20">00864</a> <span class="keywordtype">void</span> <a class="code" href="classWin__QextSerialPort.html#a20">Win_QextSerialPort::setRts</a>(<span class="keywordtype">bool</span> set) {
00865     LOCK_MUTEX();
00866     <span class="keywordflow">if</span> (portOpen) {
00867         <span class="keywordflow">if</span> (set) {
00868             EscapeCommFunction(Win_Handle, SETRTS);
00869         }
00870         <span class="keywordflow">else</span> {
00871             EscapeCommFunction(Win_Handle, CLRRTS);
00872         }
00873     }
00874     UNLOCK_MUTEX();
00875 }
00876 
<a name="l00896"></a><a class="code" href="classWin__QextSerialPort.html#a21">00896</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="classWin__QextSerialPort.html#a21">Win_QextSerialPort::lineStatus</a>(<span class="keywordtype">void</span>) {
00897     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> Status=0, Temp=0;
00898     LOCK_MUTEX();
00899     <span class="keywordflow">if</span> (portOpen) {
00900         GetCommModemStatus(Win_Handle, &amp;Temp);
00901         <span class="keywordflow">if</span> (Temp&amp;MS_CTS_ON) {
00902             Status|=LS_CTS;
00903         }
00904         <span class="keywordflow">if</span> (Temp&amp;MS_DSR_ON) {
00905             Status|=LS_DSR;
00906         }
00907         <span class="keywordflow">if</span> (Temp&amp;MS_RING_ON) {
00908             Status|=LS_RI;
00909         }
00910         <span class="keywordflow">if</span> (Temp&amp;MS_RLSD_ON) {
00911             Status|=LS_DCD;
00912         }
00913     }
00914     UNLOCK_MUTEX();
00915     <span class="keywordflow">return</span> Status;
00916 }
00917 
<a name="l00922"></a><a class="code" href="classWin__QextSerialPort.html#a24">00922</a> <span class="keywordtype">void</span> <a class="code" href="classWin__QextSerialPort.html#a24">Win_QextSerialPort::setTimeout</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> sec, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> millisec) {
00923     LOCK_MUTEX();
00924     Settings.Timeout_Sec=sec;
00925     Settings.Timeout_Millisec=millisec;
00926     <span class="keywordflow">if</span>(portOpen) {
00927         Win_CommTimeouts.ReadIntervalTimeout = sec*1000+millisec;
00928         Win_CommTimeouts.ReadTotalTimeoutMultiplier = sec*1000+millisec;
00929         Win_CommTimeouts.ReadTotalTimeoutConstant = 0;
00930         Win_CommTimeouts.WriteTotalTimeoutMultiplier = sec*1000+millisec;
00931         Win_CommTimeouts.WriteTotalTimeoutConstant = 0;
00932         SetCommTimeouts(Win_Handle, &amp;Win_CommTimeouts);
00933     }
00934     UNLOCK_MUTEX();
00935 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Jul 9 11:14:24 2005 for QextSerialPort by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > </a>1.3.6 </small></address>
</body>
</html>
